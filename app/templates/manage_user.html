{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='manage.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<main class="container-fluid py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2 class="mt-4 text-purple border-bottom">User Management üßë‚Äçüíª</h2>
    
    <div class="mb-3">
        <label for="viewTypeSelect" class="form-label">View:</label>
        <select id="viewTypeSelect" class="form-select w-auto d-inline-block" onchange="window.location.href='{{ url_for('manage_user.manage') }}?view_type=' + this.value;">
            <option value="pending" {% if view_type == 'pending' %}selected{% endif %}>Pending Requests</option>
            <option value="approved" {% if view_type == 'approved' %}selected{% endif %}>Manage Users</option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th class="email-col">Email</th>
                    <th class="name-col">Name</th>
                    <th>Role</th>
                    <th class="hide-mobile">Phone Number</th>
                    <th class="hide-mobile">Student Number</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if pending_users %}
                    {% for user in pending_users %}
                        <tr>
                            <td class="email-col">{{ user.email }}</td>
                            <td class="name-col">{{ user.fname }} {{ user.lname }}</td>
                            <td>{{ user.role }}</td>
                            <td class="hide-mobile">{{ user.phone_number }}</td>
                            <td class="hide-mobile">{{ user.student_number if user.student_number else 'N/A' }}</td>
                            <td>{{ user.status }}</td>
                            <td>
                                <div class="action-buttons">
                                    {% if view_type == 'pending' %}
                                        <form method="POST" action="{{ url_for('manage_user.manage', view_type=view_type) }}" style="display: inline;">
                                            <input type="hidden" name="user_id" value="{{ user._id }}">
                                            <button type="submit" name="action" value="approve" class="btn btn-sm btn-success me-1" title="Approve">
                                                <i class="fa-solid fa-check"></i>
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('manage_user.manage', view_type=view_type) }}" style="display: inline;">
                                            <input type="hidden" name="user_id" value="{{ user._id }}">
                                            <button type="submit" name="action" value="deny" class="btn btn-sm btn-danger me-1" title="Deny">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('manage_user.manage', view_type=view_type) }}" style="display: inline;">
                                            <input type="hidden" name="user_id" value="{{ user._id }}">
                                            <button type="submit" name="action" value="delete" class="btn btn-sm btn-danger me-1" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('manage_user.manage', view_type=view_type) }}" style="display: inline;">
                                            <input type="hidden" name="user_id" value="{{ user._id }}">
                                            <select name="action" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit();">
                                                <option value="" selected disabled>Change Role</option>
                                                <option value="role_admin">Admin</option>
                                                <option value="role_user">User</option>
                                            </select>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No {{ 'pending requests' if view_type == 'pending' else 'approved users' }} found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // Debug form submissions
        $('form').on('submit', function(e) {
            console.log('Form submitted to:', $(this).attr('action'));
            const formData = $(this).serialize();
            console.log('Form data:', formData);
        });
    });
</script>
{% endblock %}