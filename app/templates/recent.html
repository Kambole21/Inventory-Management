{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='recent.css')}}">

<main class="container-fluid py-4">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}
    <h1 class="mt-4 text-purple">Recent Inventories</h1>

    <div class="card shadow-sm p-3 mb-4 bg-light-cream">
        <h5 class="text-purple">Filter Inventories</h5>
        <div class="row g-3">
            <div class="col-md-6">
                <label for="filterCreatedBy" class="form-label text-purple">Created by</label>
                <input type="text" class="form-control" id="filterCreatedBy" placeholder="Enter name">
            </div>
            <div class="col-md-6">
                <label for="filterDate" class="form-label text-purple">Date</label>
                <input type="date" class="form-control" id="filterDate">
            </div>
        </div>
    </div>

    <div class="card shadow-sm p-3 bg-light-cream" style="cursor: pointer;">
        <h5 class="text-purple">Recent Inventory Submissions</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>No</th>
                        <th>Department/School</th>
                        <th>Created by</th>
                        <th>Total Items</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inventory in recent_inventories %}
                        <tr onclick="window.location.href='{{ url_for('default_inventory.view_inventory', inventory_id=inventory._id) }}'">
                            <td>{{ loop.index }}</td>
                            <td>{{ inventory.department_school if inventory.department_school else 'N/A' }}</td>
                            <td>{{ inventory.created_by }}</td>
                            <td>{{ inventory.rows|length if inventory.rows else 0 }}</td>
                            <td>{{ inventory.submission_date[:10] }}</td>
                            <td>
                                <a href="#" class="btn btn-sm btn-danger delete-btn" data-id="{{ inventory._id }}"><i class="fa-solid fa-trash pe-2"></i></a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#filterCreatedBy, #filterDate').on('input', function() {
            const createdBy = $('#filterCreatedBy').val().toLowerCase();
            const date = $('#filterDate').val();
            $('table tbody tr').each(function() {
                const rowCreatedBy = $(this).find('td:eq(2)').text().toLowerCase();
                const rowDate = $(this).find('td:eq(4)').text();
                const match = (!createdBy || rowCreatedBy.includes(createdBy)) &&
                             (!date || rowDate === date);
                $(this).toggle(match);
            });
        });

        $('.delete-btn').on('click', function(e) {
            e.preventDefault();
            const inventoryId = $(this).data('id');
            if (confirm('Are you sure you want to delete this inventory? This action cannot be undone.')) {
                window.location.href = '{{ url_for("recent.delete_inventory", inventory_id="") }}' + inventoryId;
            }
        });
    });
</script>

{% endblock %}